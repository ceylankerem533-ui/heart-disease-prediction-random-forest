# -*- coding: utf-8 -*-
"""Random_forest model and app

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/16fTy0MN6HMdA5qQtIX46_a-jYSlDHkvs
"""

import pandas as pd
import numpy as np
from sklearn.model_selection import train_test_split
from sklearn.ensemble import RandomForestClassifier
import gradio as gr
import sys

# 1. VERÄ°YÄ° YÃœKLE VE KONTROL ET
try:
    df = pd.read_csv("/content/Heart_Disease_Prediction.csv")
    print("âœ… Veri baÅŸarÄ±yla yÃ¼klendi!")
except Exception as e:
    print(f"âŒ DOSYA YÃœKLENEMEDÄ°! Hata: {e}")
    sys.exit()

# SÃ¼tun isimlerini otomatik alalÄ±m (Hata payÄ±nÄ± sÄ±fÄ±rlamak iÃ§in)
target_col = "Heart Disease"
X = df.drop(target_col, axis=1)
y = df[target_col]

# SÃ¼tun listesini kaydedelim (Gradio giriÅŸ sÄ±rasÄ± iÃ§in kritik)
feature_names = X.columns.tolist()

# 2. MODELÄ° EÄÄ°T
X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42)
model = RandomForestClassifier(n_estimators=100, random_state=42)
model.fit(X_train, y_train)

# 3. TAHMÄ°N FONKSÄ°YONU
def predict_heart_disease(*args):
    try:
        # Gelen argÃ¼manlarÄ± bir liste yapÄ±p DataFrame'e Ã§eviriyoruz
        # Bu yÃ¶ntem sÃ¼tun ismi hatalarÄ±nÄ± tamamen engeller
        input_df = pd.DataFrame([args], columns=feature_names)

        prediction = model.predict(input_df)[0]
        probs = model.predict_proba(input_df)[0]
        conf = np.max(probs) * 100

        # Sonucu belirle (Hem sayÄ± hem metin kontrolÃ¼)
        p_str = str(prediction).lower()
        if p_str == "presence" or p_str == "1" or p_str == "yes":
            res = "âš ï¸ KALP HASTALIÄI RÄ°SKÄ° VAR"
        else:
            res = "âœ… RÄ°SK DÃœÅÃœK / YOK"

        return f"{res}\n(GÃ¼ven OranÄ±: %{conf:.2f})"

    except Exception as e:
        return f"ğŸš¨ Tahmin hatasÄ± oluÅŸtu: {str(e)}"

# 4. GRADIO ARAYÃœZÃœ (GiriÅŸleri otomatik oluÅŸturuyoruz)
inputs = []
for col in feature_names:
    # Veri tipine gÃ¶re otomatik input tÃ¼rÃ¼ seÃ§elim
    if df[col].nunique() <= 5: # Az seÃ§enekli ise (Cinsiyet, EKG vb.)
        choices = sorted(df[col].unique().tolist())
        inputs.append(gr.Dropdown(choices=choices, label=col, value=choices[0]))
    else: # Ã‡ok seÃ§enekli ise (YaÅŸ, Kolesterol vb.)
        min_val = float(df[col].min())
        max_val = float(df[col].max())
        inputs.append(gr.Number(label=col, value=int((min_val + max_val)/2)))

demo = gr.Interface(
    fn=predict_heart_disease,
    inputs=inputs,
    outputs=gr.Textbox(label="Analiz Sonucu"),
    title="â¤ï¸ Kalp SaÄŸlÄ±ÄŸÄ± Analiz Sistemi (Hata AyÄ±klama Modu)",
    description="Bu sÃ¼rÃ¼m sÃ¼tun isimlerini otomatik eÅŸleÅŸtirir."
)

if __name__ == "__main__":
    demo.launch(debug=True, share=True)

